<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Management - Vendor Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
        }
        .modal.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Menu Management</h1>
                        <p class="text-gray-600 mt-1">Manage your restaurant's menu items</p>
                    </div>
                    <button 
                        id="addItemBtn"
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        data-testid="button-add-item"
                    >
                        ➕ Add Item
                    </button>
                </div>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500">Total Items</h3>
                    <p class="text-2xl font-bold text-gray-900" data-testid="text-total-items" id="totalItems">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500">Available Items</h3>
                    <p class="text-2xl font-bold text-green-600" data-testid="text-available-items" id="availableItems">0</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-sm font-medium text-gray-500">Categories</h3>
                    <p class="text-2xl font-bold text-gray-900" data-testid="text-categories" id="categoriesCount">0</p>
                </div>
            </div>

            <!-- Menu Items Grid -->
            <div id="menuItemsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Menu items will be loaded here -->
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                    <span class="text-4xl text-gray-400">➕</span>
                </div>
                <h3 class="text-lg font-semibold mb-2">No menu items yet</h3>
                <p class="text-gray-600 mb-4">Start building your menu by adding your first item</p>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="text-lg">Loading menu items...</div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Add New Menu Item</h2>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <form id="addItemForm" class="space-y-4">
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium mb-1">Item Name *</label>
                            <input
                                id="name"
                                name="name"
                                type="text"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Chicken Karahi"
                                data-testid="input-item-name"
                            />
                        </div>
                        
                        <div>
                            <label for="categoryId" class="block text-sm font-medium mb-1">Category</label>
                            <select
                                id="categoryId"
                                name="categoryId"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                data-testid="select-category"
                            >
                                <option value="">Select category</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="description" class="block text-sm font-medium mb-1">Description</label>
                        <textarea
                            id="description"
                            name="description"
                            rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Delicious traditional chicken curry with aromatic spices..."
                            data-testid="textarea-description"
                        ></textarea>
                    </div>

                    <!-- Price and Details -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="price" class="block text-sm font-medium mb-1">Price (PKR) *</label>
                            <input
                                id="price"
                                name="price"
                                type="number"
                                required
                                min="0"
                                step="0.01"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="850"
                                data-testid="input-price"
                            />
                        </div>
                        
                        <div>
                            <label for="preparationTime" class="block text-sm font-medium mb-1">Prep Time (minutes)</label>
                            <input
                                id="preparationTime"
                                name="preparationTime"
                                type="number"
                                min="1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="25"
                                data-testid="input-prep-time"
                            />
                        </div>
                        
                        <div>
                            <label for="calories" class="block text-sm font-medium mb-1">Calories</label>
                            <input
                                id="calories"
                                name="calories"
                                type="number"
                                min="0"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="650"
                                data-testid="input-calories"
                            />
                        </div>
                    </div>

                    <!-- Ingredients and Allergens -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="ingredients" class="block text-sm font-medium mb-1">Ingredients (comma separated)</label>
                            <textarea
                                id="ingredients"
                                name="ingredients"
                                rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Chicken, Tomatoes, Onions, Ginger, Garlic"
                                data-testid="textarea-ingredients"
                            ></textarea>
                        </div>
                        
                        <div>
                            <label for="allergens" class="block text-sm font-medium mb-1">Allergens (comma separated)</label>
                            <textarea
                                id="allergens"
                                name="allergens"
                                rows="2"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Dairy, Nuts"
                                data-testid="textarea-allergens"
                            ></textarea>
                        </div>
                    </div>

                    <!-- Image URL -->
                    <div>
                        <label for="image" class="block text-sm font-medium mb-1">Image URL</label>
                        <input
                            id="image"
                            name="image"
                            type="url"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="https://example.com/chicken-karahi.jpg"
                            data-testid="input-image"
                        />
                    </div>

                    <!-- Dietary Options -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium">Dietary Information</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <label class="flex items-center space-x-2">
                                <input
                                    type="checkbox"
                                    name="isVegetarian"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    data-testid="checkbox-vegetarian"
                                />
                                <span class="text-sm">Vegetarian</span>
                            </label>
                            
                            <label class="flex items-center space-x-2">
                                <input
                                    type="checkbox"
                                    name="isVegan"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    data-testid="checkbox-vegan"
                                />
                                <span class="text-sm">Vegan</span>
                            </label>
                            
                            <label class="flex items-center space-x-2">
                                <input
                                    type="checkbox"
                                    name="isSpicy"
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    data-testid="checkbox-spicy"
                                />
                                <span class="text-sm">Spicy</span>
                            </label>
                            
                            <label class="flex items-center space-x-2">
                                <input
                                    type="checkbox"
                                    name="isAvailable"
                                    checked
                                    class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    data-testid="checkbox-available"
                                />
                                <span class="text-sm">Available</span>
                            </label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end space-x-4 pt-4">
                        <button 
                            type="button"
                            id="cancelBtn"
                            class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300"
                            data-testid="button-cancel"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                            data-testid="button-submit"
                        >
                            Add Item
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let menuItems = [];
        let categories = [];
        let isLoading = false;

        // Modal controls
        const modal = document.getElementById('addItemModal');
        const addItemBtn = document.getElementById('addItemBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const form = document.getElementById('addItemForm');

        // Show modal
        function showModal() {
            modal.classList.add('show');
        }

        // Hide modal
        function hideModal() {
            modal.classList.remove('show');
            form.reset();
        }

        // Event listeners  
        console.log('Setting up event listeners...');
        console.log('addItemBtn found:', !!addItemBtn);
        console.log('modal found:', !!modal);
        
        if (addItemBtn && modal) {
            addItemBtn.addEventListener('click', function() {
                console.log('Add Item button clicked!');
                showModal();
            });
            
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', hideModal);
            }
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideModal);
            }
            console.log('Event listeners added successfully!');
        } else {
            console.error('Required elements not found!', { 
                addItemBtn: !!addItemBtn, 
                modal: !!modal,
                closeModalBtn: !!closeModalBtn,
                cancelBtn: !!cancelBtn 
            });
        }

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideModal();
            }
        });

        // Load categories
        async function loadCategories() {
            try {
                const response = await fetch('/api/menu-categories');
                if (response.ok) {
                    categories = await response.json();
                    
                    // Populate category dropdown
                    const categorySelect = document.getElementById('categoryId');
                    categorySelect.innerHTML = '<option value="">Select category</option>';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                    
                    // Update categories count
                    document.getElementById('categoriesCount').textContent = categories.length;
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load menu items
        async function loadMenuItems() {
            try {
                const response = await fetch('/api/menu-items');
                if (response.ok) {
                    menuItems = await response.json();
                    renderMenuItems();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading menu items:', error);
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        // Render menu items
        function renderMenuItems() {
            const grid = document.getElementById('menuItemsGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (menuItems.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            grid.innerHTML = menuItems.map(item => `
                <div class="bg-white rounded-lg shadow overflow-hidden" data-testid="card-item-${item.id}">
                    ${item.image ? `
                        <div class="aspect-video overflow-hidden">
                            <img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover">
                        </div>
                    ` : ''}
                    
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold leading-tight">${item.name}</h3>
                            <span class="${item.isAvailable ? 'text-green-600' : 'text-red-500'}">
                                ${item.isAvailable ? '👁️' : '👁️‍🗨️'}
                            </span>
                        </div>
                        <div class="text-2xl font-bold text-blue-600 mb-3">
                            ${item.currency} ${parseFloat(item.price).toLocaleString()}
                        </div>
                        
                        ${item.description ? `
                            <p class="text-sm text-gray-600 mb-3 line-clamp-2">${item.description}</p>
                        ` : ''}
                        
                        <!-- Dietary badges -->
                        <div class="flex flex-wrap gap-1 mb-3">
                            ${item.isVegetarian ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Vegetarian</span>' : ''}
                            ${item.isVegan ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Vegan</span>' : ''}
                            ${item.isSpicy ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Spicy 🌶️</span>' : ''}
                        </div>
                        
                        <!-- Additional info -->
                        <div class="flex justify-between text-xs text-gray-500 mb-3">
                            ${item.preparationTime ? `<span>⏱️ ${item.preparationTime} min</span>` : '<span></span>'}
                            ${item.calories ? `<span>🔥 ${item.calories} cal</span>` : '<span></span>'}
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex justify-end space-x-1">
                            <button class="p-2 text-gray-600 hover:text-blue-600 border rounded">✏️</button>
                            <button class="p-2 text-gray-600 hover:text-red-600 border rounded">🗑️</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalItems').textContent = menuItems.length;
            document.getElementById('availableItems').textContent = menuItems.filter(item => item.isAvailable).length;
        }

        // Handle form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isLoading) return;
            isLoading = true;
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Adding...';
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(form);
                const data = {
                    name: formData.get('name'),
                    description: formData.get('description') || null,
                    price: formData.get('price'),
                    currency: 'PKR',
                    image: formData.get('image') || null,
                    ingredients: formData.get('ingredients') ? formData.get('ingredients').split(',').map(i => i.trim()).filter(Boolean) : [],
                    allergens: formData.get('allergens') ? formData.get('allergens').split(',').map(a => a.trim()).filter(Boolean) : [],
                    isVegan: formData.get('isVegan') === 'on',
                    isVegetarian: formData.get('isVegetarian') === 'on',
                    isSpicy: formData.get('isSpicy') === 'on',
                    preparationTime: formData.get('preparationTime') ? parseInt(formData.get('preparationTime')) : null,
                    calories: formData.get('calories') ? parseInt(formData.get('calories')) : null,
                    isAvailable: formData.get('isAvailable') === 'on',
                    displayOrder: 0,
                    restaurantId: "1", // This should come from auth context
                    categoryId: formData.get('categoryId') || null
                };
                
                const response = await fetch('/api/menu-items', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });
                
                if (response.ok) {
                    const newItem = await response.json();
                    menuItems.unshift(newItem);
                    renderMenuItems();
                    updateStats();
                    hideModal();
                    
                    // Show success message
                    alert('Menu item added successfully!');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add menu item');
                }
            } catch (error) {
                console.error('Error adding menu item:', error);
                alert('Failed to add menu item. Please try again.');
            } finally {
                isLoading = false;
                submitBtn.textContent = 'Add Item';
                submitBtn.disabled = false;
            }
        });

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadMenuItems();
        });
    </script>
</body>
</html>